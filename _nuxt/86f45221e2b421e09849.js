(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{343:function(n,t){const e={render:function(){this.$createElement;return this._self._c,this._m(0)},staticRenderFns:[function(){var n=this,t=n.$createElement,e=n._self._c||t;return e("div",{staticClass:"frontmatter-markdown"},[e("p",[n._v("Docker上開発環境を構築してみた")]),n._v(" "),e("ul",[e("li",[n._v("Stack: php, Laravel, nginx, postgres")])]),n._v(" "),e("h2",[n._v("各環境ファイル作成")]),n._v(" "),e("p",[e("strong",[n._v("docker-compose.yml")])]),n._v(" "),e("pre",{staticClass:"language-yaml"},[e("code",{pre:!0,attrs:{class:"language-yaml"}},[e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[n._v("'3'")]),n._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("services")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" \n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("nginx")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" \n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("build")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" ./nginx\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" \n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" 8080"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[n._v("80 ")]),n._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" \n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" ./nginx/nginx.conf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/etc/nginx/conf.d/default.conf\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" ./src"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/var/www/app\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("depends_on")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" \n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" web\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("web")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("build")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" ./src\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" \n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" ./src"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/var/www/app\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("depends_on")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" \n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" db\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("db")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[n._v("'postgres:9.3'")]),n._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[n._v('"5432:5432"')]),n._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("env_file")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" ./data/env_file\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# - ./data/postgres:/var/lib/postgresql/data")]),n._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" pgdata"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/var/lib/postgresql/data\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# volumes:")]),n._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[n._v("#   pgdata:")]),n._v("\n")])]),n._v(" "),e("p",[e("strong",[n._v("data/env_file")])]),n._v(" "),e("pre",{staticClass:"language-dotenv"},[e("code",{pre:!0,attrs:{class:"language-dotenv"}},[n._v("POSTGRES_USER=postgres\nPOSTGRES_DB=my_db\nPOSTGRES_PASSWORD=postgres\n")])]),n._v(" "),e("p",[e("strong",[n._v("nginx/nginx.conf")])]),n._v(" "),e("pre",{staticClass:"language-yaml"},[e("code",{pre:!0,attrs:{class:"language-yaml"}},[n._v("server "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    listen 80;\n    server_name app;\n\n    root  /var/www/app;\n    index index.php index.html;\n\n    access_log /var/log/nginx/access.log;\n    error_log  /var/log/nginx/error.log;\n\n    location / "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n        try_files $uri $uri/ /index.php$is_args$args;\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\n    location ~ \\.php$ "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n        fastcgi_pass web"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("9000;\n        fastcgi_index index.php;    \n        fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n        include       fastcgi_params;\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])]),n._v(" "),e("h2",[n._v("起動")]),n._v(" "),e("pre",{staticClass:"language-sh"},[e("code",{pre:!0,attrs:{class:"language-sh"}},[n._v("docker-compose up -d\n")])]),n._v(" "),e("p",[n._v("ここで"),e("strong",[n._v("web")]),n._v(", "),e("strong",[n._v("nginx")]),n._v(", "),e("strong",[n._v("db")]),n._v("の３サービスが立ち上がって、"),e("strong",[n._v("localhost:8080")]),n._v("アクセスできる")]),n._v(" "),e("h2",[n._v("ファイル変更して、際ビルドしたい場合")]),n._v(" "),e("pre",{staticClass:"language-sh"},[e("code",{pre:!0,attrs:{class:"language-sh"}},[n._v("docker-compose up -d --build\n")])]),n._v(" "),e("h2",[n._v("解説")]),n._v(" "),e("ul",[e("li",[e("p",[n._v("Dockerはデータを持たない為、再起動するとデータ損失")])]),n._v(" "),e("li",[e("p",[n._v("データ損失を防ぐ為、"),e("strong",[n._v("volumes")]),n._v("を使用する")])]),n._v(" "),e("li",[e("p",[e("strong",[n._v("postgres")]),n._v("イメージは"),e("strong",[n._v("env_file")]),n._v("の情報でデータベースを作成する")])]),n._v(" "),e("li",[e("p",[e("strong",[n._v("postgres")]),n._v("のデータを"),e("strong",[n._v("volumes")]),n._v("に格納すれば、データ維持できる")])])]),n._v(" "),e("pre",{staticClass:"language-yaml"},[e("code",{pre:!0,attrs:{class:"language-yaml"}},[n._v("    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" ./data/postgres"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/var/lib/postgresql/data\n")])]),n._v(" "),e("ul",[e("li",[n._v("Windows環境ではなんだかこのような"),e("strong",[n._v("volumes")]),n._v("マウントしかたは上手く行きそうにないのでで、ネームvolumesに修正した")])]),n._v(" "),e("blockquote",[e("p",[n._v('FATAL: data directory "/var/lib/postgresql/data" has wrong ownership')])]),n._v(" "),e("pre",{staticClass:"language-yaml"},[e("code",{pre:!0,attrs:{class:"language-yaml"}},[n._v("    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" pgdata"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/var/lib/postgresql/data\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("pgdata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n")])]),n._v(" "),e("ul",[e("li",[e("strong",[n._v("docker-compose up -d")]),n._v("を実行すると、以下が起こる\n"),e("ul",[e("li",[e("strong",[n._v("myapp_default")]),n._v("ネットワークが作られる。")]),n._v(" "),e("li",[e("strong",[n._v("web")]),n._v(", "),e("strong",[n._v("nginx")]),n._v(", "),e("strong",[n._v("db")]),n._v("の３サービスが作成され、"),e("strong",[n._v("myapp_default")]),n._v("にジョイン")]),n._v(" "),e("li",[e("strong",[n._v("myapp_default")]),n._v("ネットワーク環境下で、名前でアクセス可能。"),e("br"),n._v("\n例"),e("strong",[n._v("web")]),n._v("から"),e("strong",[n._v("db")]),n._v("でデータベースをアクセス、"),e("br"),n._v(" "),e("strong",[n._v("nginx")]),n._v("で"),e("strong",[n._v("web")]),n._v("を使って、"),e("strong",[n._v("web")]),n._v("をアクセス\\")])])])])])}]};n.exports={attributes:{title:"[Docker]メモ",date:"2018-04-30T22:29:03.000Z",thumbnail:"posts/docker.png",description:"docker-composeでPHP開発環境を構築",tags:["docker"]},html:'<p>Docker上開発環境を構築してみた</p>\n<ul>\n<li>Stack: php, Laravel, nginx, postgres</li>\n</ul>\n<h2>各環境ファイル作成</h2>\n<p><strong>docker-compose.yml</strong></p>\n<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span> \n  <span class="token key atrule">nginx</span><span class="token punctuation">:</span> \n    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./nginx\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span> \n      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">80 </span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span> \n      <span class="token punctuation">-</span> ./nginx/nginx.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/default.conf\n      <span class="token punctuation">-</span> ./src<span class="token punctuation">:</span>/var/www/app\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> \n      <span class="token punctuation">-</span> web\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./src\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span> \n      <span class="token punctuation">-</span> ./src<span class="token punctuation">:</span>/var/www/app\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> \n      <span class="token punctuation">-</span> db\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">\'postgres:9.3\'</span>\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">"5432:5432"</span>\n    <span class="token key atrule">env_file</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> ./data/env_file\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token comment"># - ./data/postgres:/var/lib/postgresql/data</span>\n      <span class="token punctuation">-</span> pgdata<span class="token punctuation">:</span>/var/lib/postgresql/data\n\n<span class="token comment"># volumes:</span>\n<span class="token comment">#   pgdata:</span>\n</code></pre>\n<p><strong>data/env_file</strong></p>\n<pre class="language-dotenv"><code class="language-dotenv">POSTGRES_USER=postgres\nPOSTGRES_DB=my_db\nPOSTGRES_PASSWORD=postgres\n</code></pre>\n<p><strong>nginx/nginx.conf</strong></p>\n<pre class="language-yaml"><code class="language-yaml">server <span class="token punctuation">{</span>\n    listen 80;\n    server_name app;\n\n    root  /var/www/app;\n    index index.php index.html;\n\n    access_log /var/log/nginx/access.log;\n    error_log  /var/log/nginx/error.log;\n\n    location / <span class="token punctuation">{</span>\n        try_files $uri $uri/ /index.php$is_args$args;\n    <span class="token punctuation">}</span>\n\n    location ~ \\.php$ <span class="token punctuation">{</span>\n        fastcgi_pass web<span class="token punctuation">:</span>9000;\n        fastcgi_index index.php;    \n        fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n        include       fastcgi_params;\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h2>起動</h2>\n<pre class="language-sh"><code class="language-sh">docker-compose up -d\n</code></pre>\n<p>ここで<strong>web</strong>, <strong>nginx</strong>, <strong>db</strong>の３サービスが立ち上がって、<strong>localhost:8080</strong>アクセスできる</p>\n<h2>ファイル変更して、際ビルドしたい場合</h2>\n<pre class="language-sh"><code class="language-sh">docker-compose up -d --build\n</code></pre>\n<h2>解説</h2>\n<ul>\n<li>\n<p>Dockerはデータを持たない為、再起動するとデータ損失</p>\n</li>\n<li>\n<p>データ損失を防ぐ為、<strong>volumes</strong>を使用する</p>\n</li>\n<li>\n<p><strong>postgres</strong>イメージは<strong>env_file</strong>の情報でデータベースを作成する</p>\n</li>\n<li>\n<p><strong>postgres</strong>のデータを<strong>volumes</strong>に格納すれば、データ維持できる</p>\n</li>\n</ul>\n<pre class="language-yaml"><code class="language-yaml">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> ./data/postgres<span class="token punctuation">:</span>/var/lib/postgresql/data\n</code></pre>\n<ul>\n<li>Windows環境ではなんだかこのような<strong>volumes</strong>マウントしかたは上手く行きそうにないのでで、ネームvolumesに修正した</li>\n</ul>\n<blockquote>\n<p>FATAL: data directory &quot;/var/lib/postgresql/data&quot; has wrong ownership</p>\n</blockquote>\n<pre class="language-yaml"><code class="language-yaml">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> pgdata<span class="token punctuation">:</span>/var/lib/postgresql/data\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  <span class="token key atrule">pgdata</span><span class="token punctuation">:</span>\n</code></pre>\n<ul>\n<li><strong>docker-compose up -d</strong>を実行すると、以下が起こる\n<ul>\n<li><strong>myapp_default</strong>ネットワークが作られる。</li>\n<li><strong>web</strong>, <strong>nginx</strong>, <strong>db</strong>の３サービスが作成され、<strong>myapp_default</strong>にジョイン</li>\n<li><strong>myapp_default</strong>ネットワーク環境下で、名前でアクセス可能。<br>\n例<strong>web</strong>から<strong>db</strong>でデータベースをアクセス、<br>\n<strong>nginx</strong>で<strong>web</strong>を使って、<strong>web</strong>をアクセス\\</li>\n</ul>\n</li>\n</ul>\n',meta:{resourcePath:"/Volumes/Data/github.com/thanhchungbtc/myblog/content/docker-memo/index.md"},vue:{component:{data:function(){return{templateRender:null}},render:function(n){return this.templateRender?this.templateRender():n("div","Rendering")},created:function(){this.templateRender=e.render,this.$options.staticRenderFns=e.staticRenderFns}}}}}}]);